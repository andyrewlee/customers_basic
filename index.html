<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Customers | Store</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.25/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.25/angular-route.min.js"></script>
  </head>
  <body data-ng-app="myApp">
    <div data-ng-controller="CustomersController">
      <div id="add_new_customer">
        <h2>Add a new customer</h2>
        <label for="name">Customer Name:</label>
        <input type="text" name="name" id="name" data-ng-model="newCustomer.name">
        <button data-ng-click="addCustomer()">Add</button>
      </div>
      <p>{{ errors }}</p>
      <div id="existing_customers">
        <input type="text" placeholder="search name..." data-ng-model="filter.name">
        <table>
          <thead>
            <tr>
              <th>Customer Name</th>
              <th>Created Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr data-ng-repeat="customer in customers | filter:filter.name | orderBy:'+created_at'">
              <td data-ng-bind="customer.name"></td>
              <td data-ng-bind="customer.created_at | date:'yyyy-MM-dd HH:mm:ss'"></td>
              <td><button data-ng-click="removeCustomer($index)">Remove</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <script>
      var myApp = angular.module('myApp', ['ngRoute']);

      myApp.controller('CustomersController', function($scope, customerFactory){
        $scope.errors = "";
        $scope.customers = customerFactory.getCustomers();
        $scope.addCustomer = function(){
                               $scope.errors = customerFactory.addCustomer($scope.newCustomer.name);
                             }
        $scope.removeCustomer = function($index){ customerFactory.removeCustomer($index); };
      });

      myApp.factory('customerFactory', function(){
        var customers = [];
        var factory = {};
        factory.getCustomers = function(){
          return customers;
        }
        factory.addCustomer = function(info) {
          var new_user = {};
          var current_date = new Date();
          for(i in customers) {
            if(customers[i]['name'] == info) {
              return "The user already exists";
            }
          }
          new_user.name = info;
          new_user.created_at = current_date;
          console.log(new_user.name);
          if(new_user.name == '') {
            return "Write something";
          }
          customers.push(new_user);
        }
        factory.removeCustomer = function(info) {
          customers.splice(info, 1);
        }
        return factory;
      });
    </script>
  </body>
</html>
